{%- comment -%}
  THEME-001: Recently Viewed Products Section
  Uses localStorage to track and display recently viewed products
  
  Add this section to product or collection templates
{%- endcomment -%}

{%- if request.page_type == 'product' -%}
  <script>
    // Track current product view
    (function() {
      const product = {
        id: {{ product.id | json }},
        title: {{ product.title | json }},
        url: {{ product.url | json }},
        image: {{ product.featured_image | image_url: width: 300 | json }},
        price: {{ product.price | json }},
        vendor: {{ product.vendor | json }}
      };
      
      let viewed = JSON.parse(localStorage.getItem('hmh_recently_viewed') || '[]');
      
      // Remove if already in list
      viewed = viewed.filter(p => p.id !== product.id);
      
      // Add to front
      viewed.unshift(product);
      
      // Keep only last 12
      viewed = viewed.slice(0, 12);
      
      localStorage.setItem('hmh_recently_viewed', JSON.stringify(viewed));
    })();
  </script>
{%- endif -%}

<section class="recently-viewed-section" id="recently-viewed-section" style="display: none;">
  <div class="recently-viewed-section__container page-width">
    <h2 class="recently-viewed-section__heading">
      {{ section.settings.heading | default: 'Recently Viewed' }}
    </h2>
    
    <div class="recently-viewed-section__grid" id="recently-viewed-grid">
      <!-- Products inserted by JavaScript -->
    </div>
  </div>
</section>

<style>
  .recently-viewed-section {
    padding: 40px 0;
    background: var(--color-background-secondary, #f9f9f9);
  }
  
  .recently-viewed-section__container {
    max-width: var(--page-width, 1200px);
    margin: 0 auto;
    padding: 0 20px;
  }
  
  .recently-viewed-section__heading {
    font-size: 1.5rem;
    margin-bottom: 24px;
    text-align: center;
  }
  
  .recently-viewed-section__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
  }
  
  .recently-viewed-card {
    background: var(--color-background, #fff);
    border-radius: 8px;
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    transition: box-shadow 0.2s, transform 0.2s;
    display: block;
  }
  
  .recently-viewed-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  
  .recently-viewed-card__image {
    aspect-ratio: 1;
    width: 100%;
    object-fit: cover;
    background: var(--color-background-secondary, #f5f5f5);
  }
  
  .recently-viewed-card__info {
    padding: 12px;
  }
  
  .recently-viewed-card__vendor {
    font-size: 0.75rem;
    color: var(--color-foreground-secondary, #666);
    margin-bottom: 4px;
  }
  
  .recently-viewed-card__title {
    font-size: 0.9rem;
    font-weight: 500;
    line-height: 1.3;
    margin-bottom: 8px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .recently-viewed-card__price {
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  @media (max-width: 640px) {
    .recently-viewed-section__grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
  }
</style>

<script>
  (function() {
    const section = document.getElementById('recently-viewed-section');
    const grid = document.getElementById('recently-viewed-grid');
    
    if (!section || !grid) return;
    
    const viewed = JSON.parse(localStorage.getItem('hmh_recently_viewed') || '[]');
    const maxProducts = {{ section.settings.max_products | default: 6 }};
    
    // Filter out current product if on product page
    const currentProductId = {{ product.id | default: 0 }};
    const products = viewed
      .filter(p => p.id !== currentProductId)
      .slice(0, maxProducts);
    
    if (products.length === 0) return;
    
    // Show section
    section.style.display = 'block';
    
    // Render products
    grid.innerHTML = products.map(product => `
      <a href="${product.url}" class="recently-viewed-card">
        <img 
          src="${product.image}" 
          alt="${product.title}"
          class="recently-viewed-card__image"
          loading="lazy"
          width="200"
          height="200"
        >
        <div class="recently-viewed-card__info">
          ${product.vendor ? `<p class="recently-viewed-card__vendor">${product.vendor}</p>` : ''}
          <h3 class="recently-viewed-card__title">${product.title}</h3>
          <p class="recently-viewed-card__price">${formatMoney(product.price)}</p>
        </div>
      </a>
    `).join('');
    
    function formatMoney(cents) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code | default: "USD" }}'
      }).format(cents / 100);
    }
  })();
</script>

{% schema %}
{
  "name": "Recently Viewed",
  "tag": "section",
  "class": "section-recently-viewed",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recently Viewed"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum products to show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed"
    }
  ]
}
{% endschema %}
